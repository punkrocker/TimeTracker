@{
    ViewBag.Title = "title";
}

<div class="page-bar">
    <ul class="page-breadcrumb">
        <li>
            <a href="index.html">Report</a>
            <i class="fa fa-circle"></i>
        </li>
        <li>
            <span>Monthly Report</span>
        </li>
    </ul>
    <div class="page-toolbar">
        <button class="btn green" type="button" data-toggle="dropdown" onclick="generate();">
            Generate
        </button>
    </div>
</div>

<div class="col-md-12">
    <div class="portlet">
        <div class="portlet-title">
            <div class="caption">
                Select A Customer
            </div>
            <select id="single" class="form-control select2 select2-hidden-accessible" tabindex="-1" aria-hidden="true" onchange="changeCustomer(this.options[this.options.selectedIndex].value)">
                <option></option>
                @foreach (var customer in ViewBag.Customers)
                {
                <option value="@customer.CustomerID">
                    @customer.CustomerName
                </option>
                }
            </select>
        </div>
    </div>
</div>

<div class="col-md-6">
    <!-- BEGIN SAMPLE TABLE PORTLET-->
    <div class="portlet">
        <div class="portlet-title">
            <div class="caption">
                <i class="fa fa-bell-o"></i>Last Month
            </div>
        </div>
        <div class="portlet-body">

            <div class="table-scrollable">
                <table class="table table-striped table-bordered table-advance table-hover">
                    <thead>
                        <tr>
                            <th>项目</th>
                            <th>实际时间</th>
                            <th>更改时间</th>
                            <th>任务数</th>
                            <th>平均时间</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (ViewBag.Model != null)
                        {
                            foreach (var reportInfo in ViewBag.Model)
                            {
                        <tr>
                            <td class="highlight" width="10%">
                                @reportInfo.ProjectName
                            </td>
                            <td class="highlight" width="10%">
                                @reportInfo.LastTime
                            </td>
                            <td class="highlight" width="10%">
                                @reportInfo.LastModify
                            </td>
                            <td class="highlight" width="10%">
                                @reportInfo.LastTask
                            </td>
                            <td class="highlight" width="10%">
                                @reportInfo.LastAvg
                            </td>
                        </tr>
                            }
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="col-md-6" onload>
    <!-- BEGIN SAMPLE TABLE PORTLET-->
    <div class="portlet">
        <div class="portlet-title">
            <div class="caption">
                <i class="fa fa-bell-o"></i>This Month
            </div>
        </div>
        <div class="portlet-body">
            <div class="table-scrollable">
                <table class="table table-striped table-bordered table-advance table-hover">
                    <thead>
                        <tr>
                            <th>项目</th>
                            <th>实际时间</th>
                            <th>更改时间</th>
                            <th>任务数</th>
                            <th>平均时间</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (ViewBag.Model != null)
                        {
                            foreach (var reportInfo in ViewBag.Model)
                            {
                                <tr>
                                    <td class="highlight" width="10%">
                                        @reportInfo.ProjectName
                                    </td>
                                    <td class="highlight" width="10%">
                                        @reportInfo.CurrentTime
                                    </td>
                                    <td id="@reportInfo.ProjectID" class="highlight" width="10%" ondblclick="edittime(@reportInfo.ProjectID)">
                                        @reportInfo.CurrentModify
                                    </td>
                                    <td class="highlight" width="10%">
                                        @reportInfo.CurrentTask
                                    </td>
                                    <td class="highlight" width="10%">
                                        @reportInfo.CurrentAvg
                                    </td>
                                </tr>
                            }
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="col-md-12">
    <textarea rows="8" id="comment" name="comment" placeholder="Write comment here ..." class="form-control input-md"></textarea>
    <div>
        <p>1、Only display your team data</p>
        <p>2、Project Summary displays each project number</p>
        <p>3、Time Spend Details display each project time in detail</p>
        <p>4、Monthly Summary shows total with Processor used, please confirm this number with Manager before report released</p>
    </div>
</div>

<script>
    reportList = [];

    function edittime(projectID) {
        var id = '#' + projectID;
        var td = $(id);
        // 根据表格文本创建文本框 并加入表表中--文本框的样式自己调整
        var text = td.text();
        var txt = $("<input type='text' class='edit_text'>").val(text);
        txt.keypress(function(event) { 
            var keyCode = event.which; 
            if (keyCode == 46 || (keyCode >= 48 && keyCode <=57)) 
                return true; 
            else 
                return false; 
        }).focus(function() { 
            this.style.imeMode='disabled'; 
        }); 
        txt.select();
        txt.blur(function () {
            // 失去焦点，保存值。于服务器交互自己再写,最好ajax
            var newText = $(this).val();
            // 移除文本框,显示新值
            $(this).remove();
            td.text(newText);
            more = newText - text;
            $.ajax({
                url: "ModifyReport",
                type: "post",
                data: { projectID: projectID, modifyTime: more },
                success: function (date) {
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    window.location.href = window.location.href;
                }
            });
        });
        td.text("");
        td.append(txt);
        txt.focus();
    }

    function generate() {
        var comment = $('#comment').val();
        $.ajax({
            url : "Report",
            type: "post",
            data: { reportList: reportList, comment: JSON.stringify(comment) },
            success: function (date) {
                var obj = window.open("about:blank");
                obj.document.write(date);
            }
        });
    }

    function changeCustomer(v) {
        window.location.href = "/Report/Index?customerID=" + v;
    }

    $(document).ready(function(){
        reportList = @Html.Raw(Json.Encode(ViewBag.Model));
    });

</script>